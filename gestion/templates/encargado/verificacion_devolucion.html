{% extends 'base.html' %}

{% block title %}Verificación de Devolución - Las Cabañitas{% endblock %}

{% block content %}
<h1 class="page-title">Verificación de Devolución - {{ reserva.cabaña.nombre }}</h1>

<div class="card">
    <h3>Información de la Reserva</h3>
    <div class="info-group">
        <p><strong>Reserva #:</strong> {{ reserva.idReserva }}</p>
        <p><strong>Cliente:</strong> {{ reserva.cliente.nombre }}</p>
        <p><strong>Cabaña:</strong> {{ reserva.cabaña.nombre }}</p>
        <p><strong>Fecha de Entrega:</strong> {{ entrega.fecha_entrega|date:"d/m/Y H:i" }}</p>
        <p><strong>Fecha de Devolución:</strong> {{ entrega.fecha_devolucion|date:"d/m/Y H:i"|default:"Pendiente" }}</p>
    </div>
</div>

<div class="card">
    <h3>Verificación de Inventario - Check-out</h3>
    <p class="alert alert-warning">Compare el estado actual con el estado inicial. El sistema calculará automáticamente los cargos por faltantes o daños.</p>

    <form method="post">
        {% csrf_token %}

        {% for categoria, items in categorias_items.items %}
        <div class="checklist-categoria">
            <h4>{{ categoria|upper }}</h4>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Entregado</th>
                    <th>Devuelto</th>
                    <th>Estado Entregado</th>
                    <th>Estado Devuelto</th>
                    <th>Cargo Estimado</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item_ver in items %}
                <tr class="item-{{ item_ver.estado_devuelto }}">
                    <td>
                        <strong>{{ item_ver.item.nombre_item }}</strong>
                        {% if item_ver.item.es_obligatorio %}
                        <span class="badge badge-warning">Obligatorio</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ item_ver.cantidad_entregada }}</strong>
                        <br><small class="status-badge-inline status-{{ item_ver.estado_entregado }}">{{ item_ver.get_estado_entregado_display }}</small>
                    </td>
                    <td>
                        <input type="number"
                               name="cantidad_{{ item_ver.idItemVerificacion }}"
                               value="{{ item_ver.cantidad_devuelta|default:item_ver.cantidad_entregada }}"
                               min="0"
                               max="{{ item_ver.cantidad_entregada }}"
                               class="form-control"
                               style="width: 80px;"
                               required
                               onchange="calcularCargo({{ item_ver.idItemVerificacion }}, {{ item_ver.item.precio_reposicion }}, {{ item_ver.cantidad_entregada }})">
                    </td>
                    <td>
                        <span class="status-badge-inline status-{{ item_ver.estado_entregado }}">{{ item_ver.get_estado_entregado_display }}</span>
                    </td>
                    <td>
                        <select name="estado_{{ item_ver.idItemVerificacion }}"
                                class="form-control"
                                id="estado_{{ item_ver.idItemVerificacion }}"
                                onchange="calcularCargo({{ item_ver.idItemVerificacion }}, {{ item_ver.item.precio_reposicion }}, {{ item_ver.cantidad_entregada }})">
                            <option value="bueno" {% if item_ver.estado_devuelto == 'bueno' %}selected{% endif %}>✅ Buen Estado</option>
                            <option value="regular" {% if item_ver.estado_devuelto == 'regular' %}selected{% endif %}>⚠️ Estado Regular</option>
                            <option value="danado" {% if item_ver.estado_devuelto == 'danado' %}selected{% endif %}>⚠️ Dañado</option>
                            <option value="faltante" {% if item_ver.estado_devuelto == 'faltante' %}selected{% endif %}>❌ Faltante</option>
                        </select>
                    </td>
                    <td>
                        <span id="cargo_{{ item_ver.idItemVerificacion }}" class="error-text">$0.00</span>
                    </td>
                    <td>
                        <input type="text"
                               name="obs_{{ item_ver.idItemVerificacion }}"
                               value="{{ item_ver.observaciones }}"
                               placeholder="Observaciones..."
                               class="form-control">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% empty %}
        <p class="alert alert-warning">No hay items registrados en el checklist para esta cabaña.</p>
        {% endfor %}

        <div class="alert alert-info mt-30">
            <h4>Resumen de Cargos</h4>
            <p><strong>Cargo Total Calculado: </strong><span id="total_cargo" class="error-text">${{ total_cargos|floatformat:2 }}</span></p>
            <p><small>* Los cargos se aplicarán automáticamente después de confirmar la verificación.</small></p>
        </div>

        <div class="form-group mt-30">
            <label for="observaciones_devolucion"><strong>Observaciones Generales de Devolución:</strong></label>
            <textarea name="observaciones_devolucion"
                      id="observaciones_devolucion"
                      rows="4"
                      class="form-control"
                      placeholder="Observaciones sobre el estado general de la cabaña al momento de la devolución...">{{ entrega.observaciones_devolucion }}</textarea>
        </div>

        <div class="form-actions mt-30">
            <button type="submit" class="btn btn-success">Completar Verificación de Devolución</button>
            <a href="{% url 'dashboard_encargado' %}" class="btn">Volver</a>
        </div>
    </form>
</div>

<script>
function calcularCargo(itemId, precioUnitario, cantidadEntregada) {
    const cantidadInput = document.querySelector('input[name="cantidad_' + itemId + '"]');
    const estadoSelect = document.getElementById('estado_' + itemId);
    const cargoSpan = document.getElementById('cargo_' + itemId);

    const cantidadDevuelta = parseInt(cantidadInput.value) || 0;
    const estado = estadoSelect.value;

    let cargo = 0;

    // Cargo por faltantes
    if (cantidadDevuelta < cantidadEntregada) {
        const faltantes = cantidadEntregada - cantidadDevuelta;
        cargo += faltantes * precioUnitario;
    }

    // Cargo por daños o estado
    if (cantidadDevuelta > 0) {
        if (estado === 'danado') {
            cargo += cantidadDevuelta * precioUnitario * 0.5;  // 50% del valor por daño
        } else if (estado === 'regular') {
            cargo += cantidadDevuelta * precioUnitario * 0.2;  // 20% del valor por estado regular
        }
    }

    cargoSpan.textContent = '$' + cargo.toFixed(2);
    cargoSpan.className = cargo > 0 ? 'error-text' : 'success-text';

    // Actualizar total
    actualizarTotalCargo();
}

function actualizarTotalCargo() {
    let total = 0;
    const cargoSpans = document.querySelectorAll('[id^="cargo_"]');
    cargoSpans.forEach(span => {
        const texto = span.textContent.replace('$', '').replace(',', '');
        total += parseFloat(texto) || 0;
    });

    const totalSpan = document.getElementById('total_cargo');
    if (totalSpan) {
        totalSpan.textContent = '$' + total.toFixed(2);
        totalSpan.className = total > 0 ? 'error-text' : 'success-text';
    }
}

// Inicializar cargos al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarTotalCargo();
});
</script>
{% endblock %}

