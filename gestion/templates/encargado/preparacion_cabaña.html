{% extends 'base.html' %}

{% block title %}Preparación de Cabaña - Las Cabañitas{% endblock %}

{% block content %}
<h1 class="page-title">Preparación de Cabaña - {{ reserva.cabaña.nombre }}</h1>

<div class="card">
    <h3>Información de la Reserva</h3>
    <div class="info-group">
        <p><strong>Reserva #:</strong> {{ reserva.idReserva }}</p>
        <p><strong>Cliente:</strong> {{ reserva.cliente.nombre }}</p>
        <p><strong>Cabaña:</strong> {{ reserva.cabaña.nombre }}</p>
        <p><strong>Fecha de Inicio:</strong> {{ reserva.fechaInicio }}</p>
        <p><strong>Fecha de Fin:</strong> {{ reserva.fechaFin }}</p>
        <p><strong>Días Restantes:</strong>
            {% if dias_restantes > 0 %}
                <span class="badge badge-info">{{ dias_restantes }} día{{ dias_restantes|pluralize }}</span>
            {% elif dias_restantes == 0 %}
                <span class="badge badge-warning">¡HOY!</span>
            {% else %}
                <span class="badge badge-danger">Atrasada</span>
            {% endif %}
        </p>
        <p><strong>Estado Preparación:</strong>
            <span class="status-badge-inline status-{{ preparacion.estado }}">
                {{ preparacion.get_estado_display }}
            </span>
        </p>
        <p><strong>Estado Cabaña:</strong>
            <span class="status-badge-inline status-{{ reserva.cabaña.estado }}">
                {{ reserva.cabaña.get_estado_display }}
            </span>
        </p>
        <p><strong>Progreso:</strong> {{ porcentaje_completado }}%</p>
    </div>
</div>

{% if reportes_faltantes_pendientes %}
<div class="card alert alert-danger">
    <h3>Reportes de Faltantes Pendientes</h3>
    <p><strong>ATENCIÓN:</strong> Esta cabaña tiene reportes de faltantes críticos pendientes. No se puede marcar como LISTA hasta que se resuelvan.</p>
    <ul>
        {% for reporte in reportes_faltantes_pendientes %}
        <li>
            <strong>Reporte #{{ reporte.idReporte }}</strong> - {{ reporte.fecha_creacion|date:"d/m/Y H:i" }}
            <br>{{ reporte.descripcion|truncatewords:20 }}
            <br><small>Estado: {{ reporte.get_estado_display }}</small>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}

    {% for categoria, items in tareas_por_categoria.items %}
    <div class="card">
        <div class="checklist-categoria">
            <h4>{{ categoria }}</h4>
        </div>

        <table>
            <thead>
                <tr>
                    <th>✓</th>
                    <th>Tarea</th>
                    <th>Estado</th>
                    <th>Completado</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr class="{% if item.completado %}item-completado{% else %}item-pendiente{% endif %}">
                    <td>
                        <input type="checkbox"
                               name="tareas_completadas"
                               value="{{ item.tarea.idTareaPreparacion }}"
                               {% if item.completado %}checked{% endif %}
                               id="tarea_{{ item.tarea.idTareaPreparacion }}">
                    </td>
                    <td>
                        <label for="tarea_{{ item.tarea.idTareaPreparacion }}" style="cursor: pointer;">
                            <strong>{{ item.tarea.nombre }}</strong>
                            {% if item.tarea.es_obligatoria %}
                            <span class="badge badge-warning">Obligatorio</span>
                            {% endif %}
                            {% if item.tarea.descripcion %}
                            <br><small class="text-muted">{{ item.tarea.descripcion }}</small>
                            {% endif %}
                        </label>
                    </td>
                    <td>
                        {% if item.completado %}
                            <span class="badge badge-success">✓ Completado</span>
                        {% else %}
                            <span class="badge badge-secondary">Pendiente</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.completado %}
                            <small>{{ item.fecha_completado|date:"d/m/Y H:i" }}</small>
                        {% else %}
                            <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}

    <div class="card">
        <h3>Verificación de Inventario</h3>
        <p class="alert alert-info">Verifica el inventario de la cabaña. Marca cada item como verificado y registra la cantidad actual.</p>

        {% if items_verificacion %}
        <table>
            <thead>
                <tr>
                    <th>✓</th>
                    <th>Item</th>
                    <th>Cantidad</th>
                    <th>Estado</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item_ver in items_verificacion %}
                <tr class="{% if item_ver.estado_entregado == 'bueno' %}item-completado{% else %}item-pendiente{% endif %}">
                    <td>
                        <input type="checkbox"
                               name="inventario_verificado_{{ item_ver.item.idChecklist }}"
                               id="inv_{{ item_ver.item.idChecklist }}"
                               onchange="actualizarSelect(this)">
                    </td>
                    <td>
                        <label for="inv_{{ item_ver.item.idChecklist }}" style="cursor: pointer;">
                            <strong>• {{ item_ver.item.nombre_item }}</strong>
                        </label>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number"
                                   name="inventario_cantidad_{{ item_ver.item.idChecklist }}"
                                   value="{{ item_ver.cantidad_entregada }}"
                                   min="0"
                                   class="form-control"
                                   style="width: 70px;"
                                   id="cantidad_{{ item_ver.item.idChecklist }}">
                            <span style="font-weight: bold;">/ {{ item_ver.item.cantidad_esperada }}</span>
                        </div>
                    </td>
                    <td>
                            <select name="inventario_estado_{{ item_ver.item.idChecklist }}"
                                    id="estado_{{ item_ver.item.idChecklist }}"
                                    class="form-control"
                                    style="width: 140px;"
                                    onchange="actualizarCheckbox(this)">
                                <option value="bueno" {% if item_ver.estado_entregado == 'bueno' %}selected{% endif %}>Bueno</option>
                                <option value="regular" {% if item_ver.estado_entregado == 'regular' %}selected{% endif %}>Regular</option>
                                <option value="danado" {% if item_ver.estado_entregado == 'danado' %}selected{% endif %}>Malo</option>
                                <option value="faltante" {% if item_ver.estado_entregado == 'faltante' %}selected{% endif %}>Faltante</option>
                            </select>
                    </td>
                    <td>
                        <input type="text"
                               name="inventario_obs_{{ item_ver.item.idChecklist }}"
                               value="{{ item_ver.observaciones }}"
                               placeholder="Observaciones..."
                               class="form-control"
                               style="width: 200px;">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="alert alert-warning">No hay items de inventario configurados para esta cabaña. Contacta al administrador.</p>
        {% endif %}
    </div>

    <div class="card">
        <h3>Observaciones Generales</h3>
        <div class="form-group">
            <label for="observaciones">Notas adicionales sobre la preparación:</label>
            <textarea name="observaciones" id="observaciones" rows="4" class="form-control" placeholder="Escribe aquí cualquier observación adicional sobre la preparación...">{{ preparacion.observaciones }}</textarea>
        </div>
    </div>

    <div class="card">
        <h3>Reportar Faltantes o Problemas</h3>
        <p class="alert alert-info">Si detectas faltantes o problemas durante la preparación, puedes crear un reporte para que el administrador lo atienda.</p>

        <div class="form-group">
            <label for="descripcion_faltantes"><strong>Descripción del Problema:</strong></label>
            <textarea name="descripcion_faltantes" id="descripcion_faltantes" rows="4" class="form-control" placeholder="Ej: Faltan 2 toallas, tetera eléctrica no calienta, necesita reemplazo..."></textarea>
        </div>

        <div class="form-group">
            <div style="display: flex; align-items: start; gap: 10px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ff9800; border-radius: 4px;">
                <input type="checkbox" name="faltantes_criticos" id="faltantes_criticos" style="margin-top: 3px;">
                <div>
                    <label for="faltantes_criticos" style="cursor: pointer; margin: 0;">
                        <strong>Marcar como Faltantes Críticos</strong>
                    </label>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #856404;">
                        Si marcas esta opción, la cabaña NO podrá estar LISTA hasta que el administrador resuelva este reporte.
                        Usa esto solo para problemas graves que impiden que la cabaña esté lista para recibir huéspedes.
                    </p>
                </div>
            </div>
        </div>

        <button type="submit" name="accion" value="crear_reporte_faltantes" class="btn btn-danger">Enviar Reporte al Administrador</button>
    </div>

    <div class="card">
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <button type="submit" class="btn btn-primary">Guardar Progreso</button>

            {% if not tiene_faltantes_criticos %}
            <button type="submit" name="completar_preparacion" value="1" class="btn btn-success">
                Completar Preparación e Ir al Checklist de Entrega
            </button>
            {% else %}
            <button type="button" class="btn btn-success" style="opacity: 0.5; cursor: not-allowed;" disabled>
                No se puede completar (hay faltantes críticos pendientes)
            </button>
            {% endif %}

            <a href="{% url 'preparar_cabañas' %}" class="btn btn-secondary">← Volver a Preparar Cabañas</a>
            <a href="{% url 'dashboard_encargado' %}" class="btn">Dashboard</a>
        </div>
    </div>
</form>

<style>
.item-completado {
    background-color: #f0f8f0;
}
.item-pendiente {
    background-color: #fff8f0;
}
</style>

<script>
function actualizarCheckbox(selectElement) {
    // Cuando cambia el select, actualizar el checkbox
    const itemId = selectElement.id.replace('estado_', '');
    const checkbox = document.getElementById('inv_' + itemId);

    if (selectElement.value === 'bueno') {
        checkbox.checked = true;
    } else {
        checkbox.checked = false;
    }
}

function actualizarSelect(checkboxElement) {
    // Cuando cambia el checkbox, actualizar el select
    const itemId = checkboxElement.id.replace('inv_', '');
    const select = document.getElementById('estado_' + itemId);

    if (checkboxElement.checked) {
        select.value = 'bueno';
    }
}

// Función antigua (mantener por compatibilidad pero no se usa)
function actualizarEstadoInventario(inputElement) {
    const itemId = inputElement.getAttribute('data-item-id');
    const cantidadEsperada = parseInt(inputElement.getAttribute('data-cantidad-esperada')) || 0;
    const cantidadInput = document.getElementById(`cantidad_${itemId}`);
    const estadoSelect = document.getElementById(`estado_${itemId}`);
    const badgeDiv = document.getElementById(`badge_estado_${itemId}`);

    const cantidadActual = parseInt(cantidadInput.value) || 0;

    // Si la cantidad es menor a la esperada, cambiar automáticamente a faltante
    if (cantidadActual < cantidadEsperada && estadoSelect.value === 'completo') {
        estadoSelect.value = 'faltante';
    }

    actualizarBadgeEstado(estadoSelect);
}

function actualizarBadgeEstado(selectElement) {
    const itemId = selectElement.getAttribute('data-item-id');
    const cantidadEsperada = parseInt(selectElement.getAttribute('data-cantidad-esperada')) || 0;
    const cantidadInput = document.getElementById(`cantidad_${itemId}`);
    const badgeDiv = document.getElementById(`badge_estado_${itemId}`);

    const cantidadActual = parseInt(cantidadInput.value) || 0;
    const estado = selectElement.value;

    let badgeHtml = '';
    if (estado === 'no_funciona') {
        badgeHtml = '<span class="badge badge-warning">NO FUNCIONA</span>';
    } else if (cantidadActual >= cantidadEsperada) {
        badgeHtml = '<span class="badge badge-success">COMPLETO</span>';
    } else {
        const faltantes = cantidadEsperada - cantidadActual;
        badgeHtml = `<span class="badge badge-danger">FALTAN ${faltantes}</span>`;
    }

    badgeDiv.innerHTML = badgeHtml;
}
</script>
{% endblock %}

